{%- comment -%}
  Build a nested category tree from site.posts (categories: [A, B, C])
  and render collapsible panels. Links point to real pages:
  /categories/a/b/c/
{%- endcomment -%}

{%- assign level = include.level | default: 0 -%}
{%- assign posts = include.posts -%}

{%- comment -%} 현재 레벨에 카테고리가 존재하는 포스트만 필터링 {%- endcomment -%}
{%- assign has_level = posts | where_exp: "p", "p.categories and p.categories.size > level" -%}

{%- if level == 0 -%}
<ul class="cat-tree">
{%- endif -%}

{%- comment -%} 같은 레벨의 이름으로 그룹핑 {%- endcomment -%}
{%- assign groups = has_level | group_by_exp: "p", "p.categories[level]" -%}
{%- assign groups = groups | sort: "name" -%}

{%- for g in groups -%}
  {%- assign display_name = g.name -%}
  {%- assign group_posts = g.items -%}

  {%- comment -%} 현재 경로 세그먼트 만들기 (0..level) {%- endcomment -%}
  {%- assign prefix = group_posts[0].categories | slice: 0, level -%}
  {%- assign segs = prefix | push: display_name -%}
  {%- assign path = segs | map: 'slugify' | join: '/' -%}
  {%- assign page_url = '/categories/' | append: path | append: '/' | relative_url -%}

  <li style="margin:.4rem 0;">
    <details class="cat-panel" {% if level < 1 %}open{% endif %}>
      <summary class="cat-header">
        <span>{{ display_name }}</span>
        <span class="cat-stats">{{ group_posts | size }}</span>
        <span class="cat-caret">▾</span>
      </summary>

      <div class="cat-children">
        {%- comment -%} 더 깊은 레벨이 있는 포스트 vs 리프 포스트 분리 {%- endcomment -%}
        {%- assign deeper_posts = "" | split: "" -%}
        {%- assign leaf_posts   = "" | split: "" -%}
        {%- for p in group_posts -%}
          {%- if p.categories.size > level | plus: 1 -%}
            {%- assign deeper_posts = deeper_posts | push: p -%}
          {%- else -%}
            {%- assign leaf_posts = leaf_posts | push: p -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if deeper_posts.size > 0 -%}
          {%- assign next_level = level | plus: 1 -%}
          {%- include category_tree.html posts=deeper_posts level=next_level -%}
        {%- endif -%}

        {%- if leaf_posts.size > 0 -%}
          <ul class="cat-posts">
          {%- for p in leaf_posts -%}
            <li class="cat-post">
              <a href="{{ p.url | relative_url }}">{{ p.title }}</a>
              <span class="post-meta">({{ p.date | date: "%Y-%m-%d" }})</span>
            </li>
          {%- endfor -%}
          </ul>
        {%- endif -%}

        <div style="padding:.2rem .9rem;">
          <a href="{{ page_url }}">이 카테고리 페이지로 이동</a>
        </div>
      </div>
    </details>
  </li>
{%- endfor -%}

{%- if level == 0 -%}
</ul>
{%- endif -%}
