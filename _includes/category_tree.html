{%- comment -%}
  Recursive category tree.
  Params:
    posts  : collection of posts to consider (required)
    level  : current depth (0 for root)
    path   : array of category segments built so far (optional)
{%- endcomment -%}

{%- assign path = path | default: "" | split: "" -%}

{%- assign groups = posts
  | group_by_exp: 'p', 'p.categories[level]'
-%}

<ul class="cat-tree">
{%- for g in groups -%}
  {%- assign child = g.name -%}
  {%- if child -%}
    {%- assign child_posts = g.items -%}
    {%- assign segs = path | push: child -%}
    {%- assign slug_path = segs | map: 'slugify' | join: '/' -%}
    {%- assign page_rel  = '/categories/' | append: slug_path | append: '/' -%}

    <li class="cat-node">
      <details class="cat-panel">
        <summary class="cat-header">
          <span>{{ child }}</span>
          <span class="cat-stats">{{ child_posts | size }}</span>
          <span class="cat-caret">▾</span>
        </summary>

        <div class="cat-children">
          <p><a href="{{ page_rel | relative_url }}">이 카테고리 페이지로 이동</a></p>

          {%- comment -%} descend one level if there are deeper categories {%- endcomment -%}
          {%- assign next_level = level | plus: 1 -%}
          {%- assign deeper_posts = "" | split: "" -%}
          {%- for p in child_posts -%}
            {%- if p.categories.size > next_level -%}
              {%- assign deeper_posts = deeper_posts | push: p -%}
            {%- endif -%}
          {%- endfor -%}

          {%- if deeper_posts.size > 0 -%}
            {%- include category_tree.html posts=deeper_posts level=next_level path=segs -%}
          {%- else -%}
            <ul class="cat-posts">
              {%- for p in child_posts -%}
                <li class="cat-post">
                  <a href="{{ p.url | relative_url }}">{{ p.title }}</a>
                  <span class="post-meta">{{ p.date | date: "%Y-%m-%d" }}</span>
                </li>
              {%- endfor -%}
            </ul>
          {%- endif -%}
        </div>
      </details>
    </li>
  {%- endif -%}
{%- endfor -%}
</ul>
