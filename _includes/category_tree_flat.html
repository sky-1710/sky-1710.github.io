{%- comment -%}
Flat category tree (카드 스타일, 최대 8단계)
각 항목은 /categories/#<slug> 로 이동 (동일 페이지 앵커)
{%- endcomment -%}

{%- assign items = "" | split: "" -%}
{%- assign guard = "|" -%}

{%- for p in site.posts -%}
  {%- assign cats = p.categories | default: "" -%}
  {%- if cats != "" and cats != empty -%}
    {%- assign n = cats | size -%}
    {%- if n > 8 -%}{%- assign n = 8 -%}{%- endif -%}
    {%- for i in (1..n) -%}
      {%- assign segs = "" | split: "" -%}
      {%- for j in (0..i-1) -%}
        {%- assign segs = segs | push: cats[j] -%}
      {%- endfor -%}
      {%- assign label = segs | join: "||" -%}
      {%- assign slug_path = segs | join: "/" -%}     
      {%- assign key   = slug_path -%}
      {%- assign probe = "|" | append: key | append: "|" -%}
      {%- unless guard contains probe -%}
        {%- assign entry = key | append: "::" | append: label -%}
        {%- assign items = items | push: entry -%}
        {%- assign guard = guard | append: key | append: "|" -%}
      {%- endunless -%}
    {%- endfor -%}
  {%- endif -%}
{%- endfor -%}

{%- assign items = items | sort -%}

<div class="card categories mb-3">
  <div class="card-body p-2">
    <ul class="list-group list-group-flush">
      {%- for entry in items -%}
        {%- assign parts = entry | split: "::" -%}
        {%- assign slug_path = parts[0] -%}
        {%- assign anchor_id = slug_path | slugify: 'raw' | replace: "/","-" -%}
        {%- assign label = parts[1] -%}
        {%- assign segs  = label | split: "||" -%}
        {%- assign depth = segs | size -%}

        {%- assign cnt = 0 -%}
        {%- for p in site.posts -%}
          {%- assign cats = p.categories | default: "" -%}
          {%- if cats and cats != empty and cats.size >= depth -%}
            {%- assign ok = true -%}
            {%- for k in (0..depth-1) -%}
              {%- if cats[k] != segs[k] -%}{%- assign ok = false -%}{%- break -%}{%- endif -%}
            {%- endfor -%}
            {%- if ok -%}{%- assign cnt = cnt | plus: 1 -%}{%- endif -%}
          {%- endif -%}
        {%- endfor -%}

        <li class="list-group-item" style="padding-left: {{ depth | minus: 1 | times: 16 }}px">
          <a href="{{ '/categories/#' | append: anchor_id | relative_url }}">
            <i class="far fa-folder fa-fw"></i> {{ segs | last }}
          </a>
          <span class="badge bg-secondary ms-2">{{ cnt }}</span>
        </li>
      {%- endfor -%}
    </ul>
  </div>
</div>

{%- comment -%} 아래: 실제 섹션들 렌더링 (앵커 타겟) {%- endcomment -%}

{%- for entry in items -%}
  {%- assign parts = entry | split: "::" -%}
  {%- assign slug_path = parts[0] -%}
  {%- assign anchor_id = slug_path | slugify: 'raw' | replace: "/","-" -%}
  {%- assign label = parts[1] -%}
  {%- assign segs  = label | split: "||" -%}
  {%- assign depth = segs | size -%}

  <section id="{{ anchor_id }}" class="my-4">
    <h2 class="h4"><i class="far fa-folder-open"></i> {{ segs | last }}</h2>
    <ul>
      {%- for p in site.posts -%}
        {%- assign cats = p.categories | default: "" -%}
        {%- if cats and cats != empty and cats.size >= depth -%}
          {%- assign ok = true -%}
          {%- for k in (0..depth-1) -%}
            {%- if cats[k] != segs[k] -%}{%- assign ok = false -%}{%- break -%}{%- endif -%}
          {%- endfor -%}
          {%- if ok -%}
            <li>
              <a href="{{ p.url | relative_url }}">{{ p.title }}</a>
              <time class="ms-2" datetime="{{ p.date | date_to_xmlschema }}">{{ p.date | date: "%Y-%m-%d" }}</time>
            </li>
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
    </ul>
  </section>
{%- endfor -%}
